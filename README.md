# m5stack-lowpower-mqtt-monitor

[![M5Stack MQTT Monitor](https://github.com/user-attachments/assets/10f7d67f-31d8-4458-b196-be0de5a500e0)](https://github.com/omiya-bonsai/m5stack-lowpower-mqtt-monitor)

---

## 概要

このプロジェクトは、M5Stack BasicをMQTTで受信した環境データ（CO2、温度、湿度）のモニターとして機能させるためのArduinoスケッチです。

**24/7運用**を前提とした**産業レベルの堅牢性**を備え、MQTT接続を維持しながらバックグラウンドでデータを受信し続けます。一定時間操作がない場合はディスプレイを完全にオフにして消費電力を抑え、いずれかのボタンを押すと即座に復帰して最新のデータを表示します。

長期運用に必要なウォッチドッグタイマー、自動復旧機能、メモリ管理、エラーハンドリングを内蔵し、ネットワーク障害やシステム異常からの自動回復が可能です。

---

## ✨ 機能

### 🎯 コア機能
- **リアルタイムデータ表示**: MQTTで受信した環境データをスタイリッシュなダークモードUIで表示
- **詳細画面**: 本体ボタンでCO2・温度・湿度の各詳細画面に切り替え可能
- **日本時間表示**: UnixタイムスタンプをJST（日本標準時）に自動変換して表示
- **データ検証**: 受信データの範囲チェックと異常値の自動フィルタリング

### ⚡ 省電力機能
- **高度な省電力機能**: 一定時間（デフォルト5分）無操作でディスプレイを完全オフ
- **常時接続**: 省電力中もWi-FiとMQTT接続を維持し、データ受信を継続
- **即時復帰**: ボタン押下でスリープから即座に復帰し、最新データを表示

### 🛡️ 堅牢性・24/7運用対応
- **ウォッチドッグタイマー**: システムハングアップ時の自動復旧（30秒間隔）
- **自動再接続**: WiFi/MQTT接続断絶からの自動復旧（タイムアウト制御付き）
- **メモリ管理**: ヒープメモリ監視とメモリリーク防止
- **エラーハンドリング**: 段階的なエラー復旧とシステム診断機能
- **定期再起動**: 24時間ごとの予定再起動でシステムの長期安定性を確保
- **フェイルセーフ**: 重大エラー発生時の緊急再起動

### 🔒 セキュリティ・管理
- **安全な設定管理**: Wi-Fi認証情報などを `config.h` に分離し、GitHubでの安全なコード共有が可能
- **システム診断**: 詳細なシステム状態ログとヘルスチェック機能

---

## 🛠️ 必要なもの

### ハードウェア
- M5Stack Basic

### ソフトウェア・ライブラリ
- Arduino IDE
- **Arduino IDEライブラリ:**
  - `M5Unified`
  - `PubSubClient`
  - `ArduinoJson`

---

## 🚀 セットアップ手順

1.  **リポジトリのクローン:**
    このリポジトリをローカルにクローンします。
    
    **HTTPSの場合:**
    ```zsh
    git clone https://github.com/omiya-bonsai/m5stack-lowpower-mqtt-monitor.git
    ```
    
    **SSHの場合:**
    ```zsh
    git clone git@github.com:omiya-bonsai/m5stack-lowpower-mqtt-monitor.git
    ```

2.  **ライブラリのインストール:**
    Arduino IDEのメニューから `スケッチ` > `ライブラリをインクルード` > `ライブラリを管理...` を開き、上記の3つのライブラリを検索してインストールします。

3.  **設定ファイルの作成:**
    `config.example.h` ファイルをコピーし、`config.h` という名前で新しいファイルを作成します。
    
    リポジトリのディレクトリ内で、以下のコマンドを実行します。
    ```zsh
    cp config.example.h config.h
    ```

4.  **個人情報の設定:**
    作成した `config.h` をテキストエディタで開き、ご自身のWi-FiのSSID・パスワード、およびMQTTブローカーの情報を書き込んで保存します。

5.  **書き込み:**
    Arduino IDEで `M5Stack_LowPower_MQTT_Monitor.ino` を開き、ボードに「M5Stack Core ESP32」を選択してスケッチを書き込みます。

6.  **動作確認:**
    書き込み完了後、M5Stackが自動的に再起動し、以下の画面が順番に表示されます：
    - スプラッシュ画面（AirSense v3.0）
    - WiFi接続中画面
    - MQTT接続中画面
    - データ待機画面
    - 環境データ表示画面（データ受信後）

---

## 📊 MQTTデータ形式

本システムは以下のJSON形式のMQTTメッセージに対応しています：

```json
{
  "timestamp": 1754454701,
  "co2": 627,
  "temp": 28.4,
  "hum": 62.7
}
```

**フィールド説明:**
- `timestamp`: Unixタイムスタンプ（秒）または時刻文字列
- `co2`: CO2濃度（ppm、0-50000の範囲）
- `temp`: 温度（℃、-50.0〜100.0の範囲）
- `hum`: 湿度（%、0.0〜100.0の範囲）

**注意:** 範囲外の値は自動的に無視され、システムログに記録されます。

---

## 🔧 カスタマイズ

### 基本設定
- **MQTTトピックの変更**: `config.h` ファイル内の `MQTT_TOPIC` の値を変更します。
- **ディスプレイオフ時間**: `.ino` ファイル冒頭の `DISPLAY_OFF_TIMEOUT` の値を変更します（ミリ秒単位）。
- **UIデザイン**: `.ino` ファイル冒頭のカラーパレット定義 (`#define COLOR_...`) の値を変更することで、お好みの配色にカスタマイズできます。

### 堅牢性設定
- **ウォッチドッグタイムアウト**: `WATCHDOG_TIMEOUT` でシステムハングアップ検出時間を調整（デフォルト30秒）
- **WiFi接続タイムアウト**: `WIFI_CONNECT_TIMEOUT` でWiFi接続の最大待機時間を設定（デフォルト30秒）
- **MQTT接続タイムアウト**: `MQTT_CONNECT_TIMEOUT` でMQTT接続の最大待機時間を設定（デフォルト10秒）
- **再起動間隔**: `REBOOT_INTERVAL` で定期再起動の間隔を変更（デフォルト24時間）
- **メモリチェック間隔**: `MEMORY_CHECK_INTERVAL` でメモリ監視の頻度を調整（デフォルト1分）

### CO2レベル閾値
CO2濃度の評価基準をカスタマイズできます：
- `CO2_EXCELLENT_THRESHOLD`: 優秀レベル（デフォルト400ppm）
- `CO2_GOOD_THRESHOLD`: 良好レベル（デフォルト800ppm）
- `CO2_FAIR_THRESHOLD`: 普通レベル（デフォルト1200ppm）

---

## 🔍 トラブルシューティング

### よくある問題と解決方法

**Q: 画面に「SYSTEM ERROR」が表示される**
A: システムが異常を検出しました。エラーメッセージを確認し、以下を試してください：
- WiFi接続の確認
- MQTTブローカーの動作確認
- 電源の再投入

**Q: WiFi接続に失敗する**
A: `config.h` の設定を確認してください：
- SSID、パスワードの綴りミス
- 2.4GHz帯のWiFiを使用しているか確認

**Q: MQTTデータが受信されない**
A: 以下を確認してください：
- MQTTブローカーの動作状況
- トピック名の一致
- JSON形式の正確性

**Q: システムが不安定になる**
A: シリアルモニタ（115200bps）でシステム診断ログを確認してください。メモリ不足やネットワーク問題が表示される場合があります。

### デバッグ方法
1. Arduino IDEのシリアルモニタを開く（115200bps）
2. システム診断情報とエラーログを確認
3. 必要に応じて設定値を調整

---

## 🏭 24/7運用について

このシステムは工場やオフィスでの長期連続運用を想定して設計されています：

### 安定性保証
- **自動復旧**: ネットワーク障害やシステム異常からの自動回復
- **予防保守**: 24時間ごとの定期再起動でメモリリークやリソース枯渇を防止
- **監視機能**: リアルタイムシステム診断とヘルスチェック

### 運用実績
- **連続稼働**: 数週間〜数ヶ月の連続運用実績
- **障害耐性**: WiFi接続断、MQTTサーバー停止からの自動復旧
- **省電力**: ディスプレイオフ時の消費電力大幅削減

---

## Acknowledgements

このプロジェクトのコード生成、デバッグ、ドキュメント作成の一部は、Anthropic Claude、およびGoogleのAIアシスタント **Gemini** の支援を受けて行われました。

[![Built with Claude](https://img.shields.io/badge/Built%20with-Claude-orange.svg)](https://claude.ai)
[![Built with Gemini](https://img.shields.io/badge/Built%20with-Gemini-blue.svg)](https://gemini.google.com)

---

## 📄 ライセンス

このプロジェクトはMITライセンスです。詳細は [LICENSE](LICENSE) ファイルをご覧ください。
